import math
import warnings


def Q27_Fake_Auckland():
    fidelity_map = {
        "0_1": 0.005627107607318493,
        "1_4": 0.006083832295232822,
        "1_0": 0.005627107607318493,
        "1_2": 0.008753486575494296,
        "2_3": 0.012686563583275995,
        "2_1": 0.008753486575494296,
        "3_2": 0.012686563583275995,
        "3_5": 0.009928171436340755,
        "4_1": 0.006083832295232822,
        "4_7": 0.009519176410124675,
        "5_3": 0.009928171436340755,
        "5_8": 0.009921422875,  # replace with avg
        "6_7": 0.011051936086061781,
        "7_10": 0.009537667266830863,
        "7_6": 0.011051936086061781,
        "7_4": 0.009519176410124675,
        "8_11": 0.011469369285632997,
        "8_9": 0.009921422875,  # replace with avg
        "8_5": 0.009921422875,  # replace with avg
        "9_8": 0.009921422875,  # replace with avg
        "10_7": 0.009537667266830863,
        "10_12": 0.009677031085944338,
        "11_8": 0.011469369285632997,
        "11_14": 0.009921422875,  # replace with avg
        "12_13": 0.00970278244374742,
        "12_10": 0.009677031085944338,
        "12_15": 0.007260771068301031,
        "13_12": 0.00970278244374742,
        "13_14": 0.006010443553518957,
        "14_16": 0.009042962208406474,
        "14_13": 0.006010443553518957,
        "14_11": 0.009921422875,  # replace with avg
        "15_18": 0.012964723838537334,
        "15_12": 0.007260771068301031,
        "16_14": 0.009042962208406474,
        "16_19": 0.010819489686150568,
        "17_18": 0.012793805001470343,
        "18_17": 0.012793805001470343,
        "18_15": 0.012964723838537334,
        "18_21": 0.019645921452834336,
        "19_20": 0.011960903786420785,
        "19_22": 0.009401566688506613,
        "19_16": 0.010819489686150568,
        "20_19": 0.011960903786420785,
        "21_23": 0.009164472547543462,
        "21_18": 0.019645921452834336,
        "22_25": 0.008705657095895769,
        "22_19": 0.009401566688506613,
        "23_21": 0.009164472547543462,
        "23_24": 0.006466994129351394,
        "24_23": 0.006466994129351394,
        "24_25": 0.009921422875,  # replace with avg
        "25_26": 0.009839313876210704,
        "25_22": 0.008705657095895769,
        "25_24": 0.009921422875,  # replace with avg
        "26_25": 0.009839313876210704,
    }
    return fidelity_map


def Q65_Fake_Ithaca():
    fidelity_map = {
        "0_10": 0.006827011666134364,
        "0_1": 0.00634065257855651,
        "1_2": 0.005983575205644798,
        "1_0": 0.00634065257855651,
        "2_3": 0.008005268416915262,
        "2_1": 0.005983575205644798,
        "3_4": 0.008529638043749566,
        "3_2": 0.008005268416915262,
        "4_3": 0.008529638043749566,
        "4_5": 0.010597401603545303,
        "4_11": 0.007758663913264491,
        "5_6": 0.01106084766461049,
        "5_4": 0.010597401603545303,
        "6_7": 0.019118918868904156,
        "6_5": 0.01106084766461049,
        "7_8": 0.006933123813207348,
        "7_6": 0.019118918868904156,
        "8_12": 0.004233533761173663,
        "8_7": 0.006933123813207348,
        "8_9": 0.004671156462632914,
        "9_8": 0.004671156462632914,
        "10_0": 0.006827011666134364,
        "10_13": 0.00667274638864665,
        "11_17": 0.00785212323712467,
        "11_4": 0.007758663913264491,
        "12_8": 0.004233533761173663,
        "12_21": 0.0044217686225790365,
        "13_10": 0.00667274638864665,
        "13_14": 0.006174280281527,
        "14_13": 0.006174280281527,
        "14_15": 0.010999448729931166,
        "15_24": 0.004841591417015595,
        "15_16": 0.008655615952963686,
        "15_14": 0.010999448729931166,
        "16_15": 0.008655615952963686,
        "16_17": 0.006962713667650111,
        "17_18": 0.0073020857625357705,
        "17_11": 0.00785212323712467,
        "17_16": 0.006962713667650111,
        "18_17": 0.0073020857625357705,
        "18_19": 0.004820754563032992,
        "19_25": 0.004109475171141824,
        "19_20": 0.005159684292662919,
        "19_18": 0.004820754563032992,
        "20_21": 0.009719066714362234,
        "20_19": 0.005159684292662919,
        "21_12": 0.0044217686225790365,
        "21_20": 0.009719066714362234,
        "21_22": 0.017668361736337068,
        "22_23": 0.007022719512606829,
        "22_21": 0.017668361736337068,
        "23_26": 0.011788819137259987,
        "23_22": 0.007022719512606829,
        "24_15": 0.004841591417015595,
        "24_29": 0.005547849693115087,
        "25_19": 0.004109475171141824,
        "25_33": 0.005155653533489041,
        "26_37": 0.007262816028121455,
        "26_23": 0.011788819137259987,
        "27_38": 0.005977922861112872,
        "27_28": 0.004683971861998593,
        "28_29": 0.005092636755797547,
        "28_27": 0.004683971861998593,
        "29_30": 0.008592230664992317,
        "29_28": 0.005092636755797547,
        "29_24": 0.005547849693115087,
        "30_31": 0.007764068911624095,
        "30_29": 0.008592230664992317,
        "31_39": 0.008464334543260454,
        "31_30": 0.007764068911624095,
        "31_32": 0.007109120269800678,
        "32_33": 0.044036479794385686,
        "32_31": 0.007109120269800678,
        "33_34": 0.005370366730294035,
        "33_32": 0.044036479794385686,
        "33_25": 0.005155653533489041,
        "34_33": 0.005370366730294035,
        "34_35": 0.010885888842296493,
        "35_40": 0.005265344911066727,
        "35_34": 0.010885888842296493,
        "35_36": 0.03350705695207021,
        "36_37": 0.008962548178681112,
        "36_35": 0.03350705695207021,
        "37_36": 0.008962548178681112,
        "37_26": 0.007262816028121455,
        "38_27": 0.005977922861112872,
        "38_41": 0.00820458283994066,
        "39_31": 0.008464334543260454,
        "39_45": 0.006831017609813417,
        "40_35": 0.005265344911066727,
        "40_49": 0.007485907742566966,
        "41_38": 0.00820458283994066,
        "41_42": 0.013454086804960491,
        "42_43": 0.02792651460447773,
        "42_41": 0.013454086804960491,
        "43_42": 0.02792651460447773,
        "43_52": 0.01011560161030195,
        "43_44": 0.011055278671153218,
        "44_45": 0.004762874825219726,
        "44_43": 0.011055278671153218,
        "45_44": 0.004762874825219726,
        "45_39": 0.006831017609813417,
        "45_46": 0.0053677245481763,
        "46_47": 0.03581904771088987,
        "46_45": 0.0053677245481763,
        "47_53": 0.00915329721116695,
        "47_46": 0.03581904771088987,
        "47_48": 0.0072852830464153195,
        "48_49": 0.005928258583449392,
        "48_47": 0.0072852830464153195,
        "49_48": 0.005928258583449392,
        "49_40": 0.007485907742566966,
        "49_50": 0.005644116520272496,
        "50_51": 0.008099148922927568,
        "50_49": 0.005644116520272496,
        "51_50": 0.008099148922927568,
        "51_54": 0.005581670869980293,
        "52_43": 0.01011560161030195,
        "52_56": 0.016768170581233616,
        "53_47": 0.00915329721116695,
        "53_60": 0.007124456663873041,
        "54_64": 0.0070859471286519315,
        "54_51": 0.005581670869980293,
        "55_56": 0.007768676086009119,
        "56_57": 0.013383296834301783,
        "56_55": 0.007768676086009119,
        "56_52": 0.016768170581233616,
        "57_56": 0.013383296834301783,
        "57_58": 0.019079328809514934,
        "58_59": 0.01240699021919131,
        "58_57": 0.019079328809514934,
        "59_58": 0.01240699021919131,
        "59_60": 0.00551977615765506,
        "60_61": 0.005439552666674563,
        "60_53": 0.007124456663873041,
        "60_59": 0.00551977615765506,
        "61_60": 0.005439552666674563,
        "61_62": 0.0073624026415518296,
        "62_63": 0.00718911557954513,
        "62_61": 0.0073624026415518296,
        "63_62": 0.00718911557954513,
        "63_64": 0.009923242292968204,
        "64_54": 0.0070859471286519315,
        "64_63": 0.00992324229296820,
    }
    return fidelity_map


def Q127_Fake_Washington():
    fidelity_map = {
        "0_14": 0.00840417249973549,
        "0_1": 0.018154783599682867,
        "1_2": 0.0059756398714097825,
        "1_0": 0.018154783599682867,
        "2_3": 0.013653057604615881,
        "2_1": 0.0059756398714097825,
        "3_4": 0.021174865347271005,
        "3_2": 0.013653057604615881,
        "4_15": 0.012459723779644744,
        "4_3": 0.021174865347271005,
        "4_5": 0.014873710639670995,
        "5_6": 0.006542902967270919,
        "5_4": 0.014873710639670995,
        "6_5": 0.006542902967270919,
        "6_7": 0.009612323121071631,
        "7_8": 0.0154671924777261,
        "7_6": 0.009612323121071631,
        "8_16": 0.03340973986214138,
        "8_9": 0.01927287976,  # add this edge, use avg value
        "8_7": 0.0154671924777261,
        "9_8": 0.01927287976,  # add this edge, use avg value
        "9_10": 0.06074733200842505,
        "10_11": 0.054397635210668566,
        "10_9": 0.06074733200842505,
        "11_10": 0.054397635210668566,
        "11_12": 0.05940808451205093,
        "12_17": 0.028912613316130098,
        "12_13": 0.015360107495991288,
        "12_11": 0.05940808451205093,
        "13_12": 0.015360107495991288,
        "14_0": 0.00840417249973549,
        "14_18": 0.0065567212982554635,
        "15_22": 0.019138955087888793,
        "15_4": 0.012459723779644744,
        "16_8": 0.03340973986214138,
        "16_26": 0.009944764080430685,
        "17_30": 0.01088939646902945,
        "17_12": 0.028912613316130098,
        "18_19": 0.011004699513129435,
        "18_14": 0.0065567212982554635,
        "19_18": 0.011004699513129435,
        "19_20": 0.006467532802564263,
        "20_33": 0.028627411432771033,
        "20_19": 0.006467532802564263,
        "20_21": 0.013959395914512923,
        "21_22": 0.013389493153568077,
        "21_20": 0.013959395914512923,
        "22_15": 0.019138955087888793,
        "22_21": 0.013389493153568077,
        "22_23": 0.009312625729351237,
        "23_22": 0.009312625729351237,
        "23_24": 0.012288158126587984,
        "24_34": 0.012930800979357893,
        "24_23": 0.012288158126587984,
        "24_25": 0.010751379685120632,
        "25_26": 0.012489403142849215,
        "25_24": 0.010751379685120632,
        "26_25": 0.012489403142849215,
        "26_27": 0.010548297562974651,
        "26_16": 0.009944764080430685,
        "27_28": 0.03375209111001301,
        "27_26": 0.010548297562974651,
        "28_35": 0.02581203135924165,
        "28_27": 0.03375209111001301,
        "28_29": 0.007161176044966022,
        "29_30": 0.012123475388186311,
        "29_28": 0.007161176044966022,
        "30_31": 0.009558619729363588,
        "30_29": 0.012123475388186311,
        "30_17": 0.01088939646902945,
        "31_30": 0.009558619729363588,
        "31_32": 0.006471358349296269,
        "32_36": 0.007571964709104179,
        "32_31": 0.006471358349296269,
        "33_39": 0.010238731727695738,
        "33_20": 0.028627411432771033,
        "34_43": 0.008004218805403251,
        "34_24": 0.012930800979357893,
        "35_28": 0.02581203135924165,
        "35_47": 0.008562121917559978,
        "36_32": 0.007571964709104179,
        "36_51": 0.008514216642086403,
        "37_52": 0.019936854220324374,
        "37_38": 0.012213892258700398,
        "38_39": 0.00841690923803981,
        "38_37": 0.012213892258700398,
        "39_33": 0.010238731727695738,
        "39_40": 0.01543856859071377,
        "39_38": 0.00841690923803981,
        "40_39": 0.01543856859071377,
        "40_41": 0.00985592950269168,
        "41_42": 0.011434916880537244,
        "41_53": 0.01846407783739376,
        "41_40": 0.00985592950269168,
        "42_41": 0.011434916880537244,
        "42_43": 0.009094139473808438,
        "43_34": 0.008004218805403251,
        "43_44": 0.009240178360632928,
        "43_42": 0.009094139473808438,
        "44_45": 0.013691616935958245,
        "44_43": 0.009240178360632928,
        "45_54": 0.045005598283211684,
        "45_44": 0.013691616935958245,
        "45_46": 0.010980779717959716,
        "46_47": 0.02322250919886651,
        "46_45": 0.010980779717959716,
        "47_35": 0.008562121917559978,
        "47_46": 0.02322250919886651,
        "47_48": 0.010754474879621362,
        "48_49": 0.01524171497576407,
        "48_47": 0.010754474879621362,
        "49_50": 0.009347690294336686,
        "49_48": 0.01524171497576407,
        "49_55": 0.013035650947636174,
        "50_51": 0.01957591439546949,
        "50_49": 0.009347690294336686,
        "51_50": 0.01957591439546949,
        "51_36": 0.008514216642086403,
        "52_56": 0.03064610049032135,
        "52_37": 0.019936854220324374,
        "53_60": 0.04048528094614057,
        "53_41": 0.01846407783739376,
        "54_45": 0.045005598283211684,
        "54_64": 0.009101922108674693,
        "55_68": 0.016566114175719182,
        "55_49": 0.013035650947636174,
        "56_52": 0.03064610049032135,
        "56_57": 0.010748004810560957,
        "57_56": 0.010748004810560957,
        "57_58": 0.008601417753724222,
        "58_71": 0.0333898323405139,
        "58_59": 0.008682078566503965,
        "58_57": 0.008601417753724222,
        "59_60": 0.03759138274914545,
        "59_58": 0.008682078566503965,
        "60_61": 0.05043733225931754,
        "60_59": 0.03759138274914545,
        "60_53": 0.04048528094614057,
        "61_60": 0.05043733225931754,
        "61_62": 0.007596955132936206,
        "62_61": 0.007596955132936206,
        "62_63": 0.006696962486173935,
        "62_72": 0.009083562953708324,
        "63_62": 0.006696962486173935,
        "63_64": 0.007094479958240224,
        "64_65": 0.011603702736395632,
        "64_63": 0.007094479958240224,
        "64_54": 0.009101922108674693,
        "65_66": 0.01099986706254874,
        "65_64": 0.011603702736395632,
        "66_65": 0.01099986706254874,
        "66_67": 0.0277664866726533,
        "66_73": 0.04127322391515603,
        "67_66": 0.0277664866726533,
        "67_68": 0.009054203440746006,
        "68_69": 0.007639928131252055,
        "68_55": 0.016566114175719182,
        "68_67": 0.009054203440746006,
        "69_68": 0.007639928131252055,
        "69_70": 0.00719776153858126,
        "70_69": 0.00719776153858126,
        "70_74": 0.01895082441109555,
        "71_58": 0.0333898323405139,
        "71_77": 0.014753890685974852,
        "72_81": 0.006543711015521758,
        "72_62": 0.009083562953708324,
        "73_85": 0.007867656002690515,
        "73_66": 0.04127322391515603,
        "74_89": 0.009195411381960894,
        "74_70": 0.01895082441109555,
        "75_90": 0.010352331370287432,
        "75_76": 0.009706694139665184,
        "76_77": 0.024358426724891635,
        "76_75": 0.009706694139665184,
        "77_71": 0.014753890685974852,
        "77_76": 0.024358426724891635,
        "77_78": 0.017781065537713275,
        "78_79": 0.012136329561829612,
        "78_77": 0.017781065537713275,
        "79_78": 0.012136329561829612,
        "79_91": 0.11145736104256737,
        "79_80": 0.007748918191927356,
        "80_81": 0.0075793350079205735,
        "80_79": 0.007748918191927356,
        "81_80": 0.0075793350079205735,
        "81_82": 0.010736186048205365,
        "81_72": 0.006543711015521758,
        "82_81": 0.010736186048205365,
        "82_83": 0.03820682254251695,
        "83_84": 0.03737490075542019,
        "83_92": 0.010327980566752631,
        "83_82": 0.03820682254251695,
        "84_83": 0.03737490075542019,
        "84_85": 0.0057187233689096895,
        "85_86": 0.048917837692158156,
        "85_73": 0.007867656002690515,
        "85_84": 0.0057187233689096895,
        "86_85": 0.048917837692158156,
        "86_87": 0.009900067218364395,
        "87_93": 0.010215333892654332,
        "87_86": 0.009900067218364395,
        "87_88": 0.006788572804618337,
        "88_89": 0.011240480292464772,
        "88_87": 0.006788572804618337,
        "89_88": 0.011240480292464772,
        "89_74": 0.009195411381960894,
        "90_94": 0.011163303882173653,
        "90_75": 0.010352331370287432,
        "91_98": 0.09344866028387726,
        "91_79": 0.11145736104256737,
        "92_83": 0.010327980566752631,
        "92_102": 0.010377415577513788,
        "93_106": 0.00867040928287871,
        "93_87": 0.010215333892654332,
        "94_90": 0.011163303882173653,
        "94_95": 0.008900776755484952,
        "95_96": 0.011111672988725674,
        "95_94": 0.008900776755484952,
        "96_95": 0.011111672988725674,
        "96_97": 0.008330557171411512,
        "96_109": 0.01927287976,  # replace with avg
        "97_96": 0.008330557171411512,
        "97_98": 0.021074826483175768,
        "98_91": 0.09344866028387726,
        "98_99": 0.021464439595628493,
        "98_97": 0.021074826483175768,
        "99_98": 0.021464439595628493,
        "99_100": 0.03491741504829973,
        "100_110": 0.015599477310015986,
        "100_101": 0.006624656340249224,
        "100_99": 0.03491741504829973,
        "101_102": 0.006600202661334653,
        "101_100": 0.006624656340249224,
        "102_101": 0.006600202661334653,
        "102_92": 0.010377415577513788,
        "102_103": 0.017066301787831917,
        "103_102": 0.017066301787831917,
        "103_104": 0.01927287976,  # replace with avg
        "104_105": 0.021349674462867507,
        "104_111": 0.00982687247338282,
        "104_103": 0.01927287976,  # replace with avg
        "105_106": 0.009948593460801514,
        "105_104": 0.021349674462867507,
        "106_105": 0.009948593460801514,
        "106_93": 0.00867040928287871,
        "106_107": 0.016064982958468393,
        "107_108": 0.025355119017805294,
        "107_106": 0.016064982958468393,
        "108_112": 0.03649265009298322,
        "108_107": 0.025355119017805294,
        "109_114": 0.01927287976,  # replace with avg
        "109_96": 0.01927287976,  # replace with avg
        "110_100": 0.015599477310015986,
        "110_118": 0.00968526418329671,
        "111_122": 0.012174606735887938,
        "111_104": 0.00982687247338282,
        "112_108": 0.03649265009298322,
        "112_126": 0.015533092924799125,
        "113_114": 0.08311777634459291,
        "114_113": 0.08311777634459291,
        "114_115": 0.08656543424950242,
        "114_109": 0.01927287976,  # replace with avg
        "115_116": 0.017942818721116083,
        "115_114": 0.08656543424950242,
        "116_115": 0.017942818721116083,
        "116_117": 0.011092356668749442,
        "117_118": 0.009709839912746737,
        "117_116": 0.011092356668749442,
        "118_117": 0.009709839912746737,
        "118_119": 0.010871446668771212,
        "118_110": 0.00968526418329671,
        "119_120": 0.016189657487130665,
        "119_118": 0.010871446668771212,
        "120_121": 0.008577704085148408,
        "120_119": 0.016189657487130665,
        "121_120": 0.008577704085148408,
        "121_122": 0.01590227116586959,
        "122_111": 0.012174606735887938,
        "122_123": 0.08153090012086986,
        "122_121": 0.01590227116586959,
        "123_124": 0.08214227754802292,
        "123_122": 0.08153090012086986,
        "124_125": 0.014599055673119199,
        "124_123": 0.08214227754802292,
        "125_124": 0.014599055673119199,
        "125_126": 0.008490855273640324,
        "126_112": 0.015533092924799125,
        "126_125": 0.008490855273640324,
    }
    return fidelity_map


def cal_sum_ln_cx_fidelity(circuit, fidelity_map, ref_swap_count):
    # calculates the sum of ln cx fidelity (i.e. base e)
    with warnings.catch_warnings():
        warnings.filterwarnings("ignore", category=DeprecationWarning)
        sum_ln_cx_fidelity = 0.0
        swap_count = 0
        for gate in circuit:
            if gate[0].name == "cx":
                error_rate = fidelity_map[f"{gate.qubits[0].index}_{gate.qubits[1].index}"]
                sum_ln_cx_fidelity += math.log(1 - error_rate)
            elif gate[0].name == "swap":
                error_rate = fidelity_map[f"{gate.qubits[0].index}_{gate.qubits[1].index}"]
                sum_ln_cx_fidelity += math.log(1 - error_rate) * 3
                swap_count += 1
        assert ref_swap_count == swap_count
    return sum_ln_cx_fidelity


def main():
    # this is a test for fidelity calculation
    from qiskit import QuantumCircuit
    circuit = QuantumCircuit(5)
    circuit.cx(0, 1)
    circuit.x(1)
    circuit.cx(1, 2)
    circuit.swap(2, 3)

    # map the circuit
    from qiskit.compiler import transpile
    from qiskit.transpiler import CouplingMap
    from qiskit.transpiler.passes import SabreLayout, SabreSwap
    from qiskit.transpiler.passmanager_config import PassManagerConfig
    from qiskit.transpiler.passmanager import PassManager

    def sabre_pass_manager(pass_manager_config: PassManagerConfig):
        # gather
        coupling_map = pass_manager_config.coupling_map
        seed_transpiler = pass_manager_config.seed_transpiler
        assert coupling_map is not None

        # build layout & routing pass using sabre
        sabre = SabreLayout(
            coupling_map,
            max_iterations=4,
            seed=seed_transpiler,
            swap_trials=20,
            layout_trials=20,
            skip_routing=False,
        )

        return PassManager(sabre)

    coupling = [
        # 1st row
        [0, 1], [1, 4], [4, 7], [7, 10], [10, 12], [12, 15], [15, 18],
        [18, 21], [21, 23],
        # 2nd row
        [3, 5], [5, 8], [8, 11], [11, 14], [14, 16], [16, 19], [19, 22],
        [22, 25], [25, 26],
        # cols
        [6, 7], [17, 18], [1, 2], [2, 3], [12, 13], [13, 14], [23, 24],
        [24, 25], [8, 9], [19, 20]
    ]
    reversed_coupling = []
    for pair in coupling:
        reversed_coupling.append([pair[1], pair[0]])
    coupling_map = CouplingMap(couplinglist=coupling + reversed_coupling)

    sabre_manager = sabre_pass_manager(PassManagerConfig(coupling_map=coupling_map, seed_transpiler=0))
    sabre_circuit = sabre_manager.run(circuit)

    print(cal_sum_ln_cx_fidelity(sabre_circuit, Q27_Fake_Auckland(), 1))


if __name__ == '__main__':
    main()
